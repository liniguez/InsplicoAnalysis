<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Scratch Insplico Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ScratchInsplicoAnalysis_files/libs/clipboard/clipboard.min.js"></script>
<script src="ScratchInsplicoAnalysis_files/libs/quarto-html/quarto.js"></script>
<script src="ScratchInsplicoAnalysis_files/libs/quarto-html/popper.min.js"></script>
<script src="ScratchInsplicoAnalysis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ScratchInsplicoAnalysis_files/libs/quarto-html/anchor.min.js"></script>
<link href="ScratchInsplicoAnalysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ScratchInsplicoAnalysis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ScratchInsplicoAnalysis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ScratchInsplicoAnalysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ScratchInsplicoAnalysis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#material" id="toc-material" class="nav-link active" data-scroll-target="#material"><span class="header-section-number">1</span> Material</a></li>
  <li><a href="#read-tables" id="toc-read-tables" class="nav-link" data-scroll-target="#read-tables"><span class="header-section-number">2</span> Read tables</a></li>
  <li><a href="#filter-exons" id="toc-filter-exons" class="nav-link" data-scroll-target="#filter-exons"><span class="header-section-number">3</span> Filter Exons</a></li>
  <li><a href="#no-replicates" id="toc-no-replicates" class="nav-link" data-scroll-target="#no-replicates"><span class="header-section-number">4</span> No Replicates</a></li>
  <li><a href="#with-replicates" id="toc-with-replicates" class="nav-link" data-scroll-target="#with-replicates"><span class="header-section-number">5</span> With Replicates</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Scratch Insplico Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/setup_3a5f61eb71fe440b9dbf4741969f7803">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(betareg)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(see)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="material" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="material"><span class="header-section-number">1</span> Material</h2>
<p>Insplico uses a tab delimited file where all exons are listed and which are going to be quantified. <a href="https://raw.githubusercontent.com/liniguez/InsplicoAnalysis/main/exons_subset_insplico.tab">Here</a> you can get a subset of one used to run insplico. Insplico is ran for each sample individually and then the output of all the runs can be merged into a single big data. <a href="https://raw.githubusercontent.com/liniguez/InsplicoAnalysis/main/subset_final_insplico.tab">Here</a> you can get a subset of a run. Here I analyzed two single cell libraries NB292 and NB293. I got the clustering of the cells based on gene expression. Alignment file was then splitted per sample into different clusters, based on cell barcodes and used as input for Insplico.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It is important to mention that each row form Insplico output correspond to each row from tab delimited exon file. More info about insplico in <a href="https://gitlab.com/aghr/insplico">here</a></p>
</div>
</div>
</section>
<section id="read-tables" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="read-tables"><span class="header-section-number">2</span> Read tables</h2>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/read_a6b53156f952beafec485659d65a451f">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>exons<span class="ot">&lt;-</span><span class="fu">fread</span>(<span class="st">"exons_subset_insplico.tab"</span>, <span class="at">nrows =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ROW=</span><span class="fu">row_number</span>())</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>insp<span class="ot">&lt;-</span><span class="fu">fread</span>(<span class="st">"subset_final_insplico.tab"</span>, <span class="at">nrows =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ROW=</span><span class="fu">row_number</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Columns UPINT_MINLEN,DOWNINT_MINLEN,INTLEN_CONSIDERED,EX_MINLEN,EX_MAXLEN are equal for all samples and can be added to exons variable.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-1_141bfe0dbb049dffef2836ab1fd42b2e">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>exons<span class="ot">&lt;-</span>insp <span class="sc">%&gt;%</span> <span class="fu">select</span>(UPINT_MINLEN,DOWNINT_MINLEN,INTLEN_CONSIDERED,EX_MINLEN,EX_MAXLEN) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(exons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For DAS analysis we will only use 4 columns:</p>
<ul>
<li><p>PSI_EX</p></li>
<li><p>EXON_INCLSPLICED_2UPSTRM</p></li>
<li><p>EXON_INCLSPLICED_2DOSTRM</p></li>
<li><p>EXON_EXCL</p></li>
</ul>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-2_7431688848c0c2c98370efd700d4088f">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>insp<span class="ot">&lt;-</span>insp <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(UPINT_MINLEN,DOWNINT_MINLEN,INTLEN_CONSIDERED,EX_MINLEN,EX_MAXLEN)) <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROW,<span class="fu">matches</span>(<span class="fu">c</span>(<span class="st">"PSI_EX"</span>,<span class="st">"EXON_INCLSPLICED_2UPSTRM"</span>,<span class="st">"EXON_INCLSPLICED_2DOSTRM"</span>,<span class="st">"EXON_EXCL"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">matches</span>(<span class="st">"WITHIRREADS"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>ROW,<span class="at">names_to =</span> <span class="st">"temp"</span>, <span class="at">values_to =</span> <span class="st">"values"</span>,<span class="at">values_drop_na =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Modify column name for getting the sample and cluster values</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-3_36cbfc249fec036c3dc6c43fbff17122">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>samples.clusters<span class="ot">&lt;-</span>stringr<span class="sc">::</span><span class="fu">str_split</span>(insp<span class="sc">$</span>temp,<span class="at">pattern =</span> <span class="st">"_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x){<span class="fu">paste0</span>(<span class="fu">rev</span>(x)[<span class="dv">1</span>],<span class="st">"."</span>,<span class="fu">rev</span>(x)[<span class="dv">2</span>])}) <span class="sc">%&gt;%</span> unlist</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>clusters<span class="ot">&lt;-</span><span class="fu">gsub</span>(<span class="st">".+</span><span class="sc">\\</span><span class="st">."</span>,<span class="at">replacement =</span> <span class="st">""</span>,samples.clusters,<span class="at">perl=</span>T)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>samples<span class="ot">&lt;-</span><span class="fu">gsub</span>(<span class="st">"</span><span class="sc">\\</span><span class="st">..+"</span>,<span class="at">replacement =</span> <span class="st">""</span>,samples.clusters,<span class="at">perl=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Classify the value into one of the 4 columns selected.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-4_d98f4b7a539cbe111c8820713beb4dfa">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>features<span class="ot">&lt;-</span><span class="fu">case_when</span>(<span class="fu">grepl</span>(<span class="st">"PSI_EX"</span>,insp<span class="sc">$</span>temp) <span class="sc">~</span> <span class="st">"PSI_EX"</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">grepl</span>(<span class="st">"EXON_INCLSPLICED_2UPSTRM"</span>,insp<span class="sc">$</span>temp) <span class="sc">~</span> <span class="st">"EXON_INCLSPLICED_2UPSTRM"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">grepl</span>(<span class="st">"EXON_INCLSPLICED_2DOSTRM"</span>,insp<span class="sc">$</span>temp) <span class="sc">~</span> <span class="st">"EXON_INCLSPLICED_2DOSTRM"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">grepl</span>(<span class="st">"EXON_EXCL"</span>,insp<span class="sc">$</span>temp) <span class="sc">~</span> <span class="st">"EXON_EXCL"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">.default =</span> <span class="cn">NA</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Add sample and count feature to the tibble</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-5_9bdfff2aa3752d37e81a4baf74689c5a">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>insp<span class="ot">&lt;-</span>insp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="st">"sample.cluster"</span><span class="ot">=</span>samples.clusters,<span class="st">"sample"</span><span class="ot">=</span>samples,<span class="st">"cluster"</span><span class="ot">=</span>clusters,<span class="st">"feature"</span><span class="ot">=</span>features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filter-exons" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="filter-exons"><span class="header-section-number">3</span> Filter Exons</h2>
<p>We then need to get the count of supporting reads for inclusion/exclusion and for that we’ll do; for long reads:</p>
<blockquote class="blockquote">
<p>(EXON_INCLSPLICED_2UPSTRM+EXON_INCLSPLICED_2DOSTRM)/2 + EXON_EXCL</p>
</blockquote>
<p>for short reads it would be something like:</p>
<blockquote class="blockquote">
<p>EXON_INCLSPLICED_2UPSTRM +EXON_INCLSPLICED_2DOSTRM + EXON_EXCL</p>
</blockquote>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-6_6ec1008d5bbafbf8f3bac9c991071906">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>rawinsp<span class="ot">&lt;-</span>insp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(feature)) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(sample,sample.cluster,cluster,ROW),<span class="at">names_from =</span> <span class="st">"feature"</span>, <span class="at">values_from =</span> <span class="st">"values"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">r_sup=</span>(EXON_INCLSPLICED_2UPSTRM<span class="sc">+</span>EXON_INCLSPLICED_2DOSTRM)<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span>EXON_EXCL)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Usually for DAS analysis exons with less than 15 reads are ignored.</p>
<p>Additionally, constitutive exons (PSI &gt; 90) and cryptic ones ( PSI &lt;10) are also removed.</p>
<p>Here we have only two samples one per group, but more complex filters can be adjusted.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-7_307279fe943c902bcfc78ab5df1c37c0">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>psiFilt<span class="ot">&lt;-</span>rawinsp <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PSI_fil=</span><span class="fu">ifelse</span>(r_sup<span class="sc">&lt;</span><span class="dv">15</span>,<span class="cn">NA</span>,PSI_EX)) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PSI_fil)) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(cluster,ROW),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">names_from =</span> <span class="st">"sample"</span>,<span class="at">values_from =</span> <span class="st">"PSI_fil"</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop_const=</span><span class="fu">apply</span>(<span class="fu">select</span>(.,<span class="sc">-</span><span class="fu">c</span>(cluster,ROW)),<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">&gt;</span><span class="fl">0.9</span>)<span class="sc">/</span><span class="fu">length</span>(x)}),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">prop_cryp=</span><span class="fu">apply</span>(<span class="fu">select</span>(.,<span class="sc">-</span><span class="fu">c</span>(cluster,ROW)),<span class="dv">1</span>,<span class="cf">function</span>(x){<span class="fu">sum</span>(x<span class="sc">&lt;</span><span class="fl">0.1</span>)<span class="sc">/</span><span class="fu">length</span>(x)}))<span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(prop_const) <span class="sc">&amp;</span> prop_const<span class="sc">&lt;=</span><span class="fl">0.5</span> <span class="sc">&amp;</span> prop_cryp<span class="sc">&lt;=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="no-replicates" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="no-replicates"><span class="header-section-number">4</span> No Replicates</h2>
<p>Lets work only with the PSI values from cluster 1. The question is whether exons are differentially spliced between the two samples of cluster 1. In this case we have only two samples, and we will compare both. For this part I used similar methods as the ones reported in the paper of <a href="https://rnajournal.cshlp.org/content/early/2024/01/26/rna.079764.123">betAS</a>. This methods are still under discussion and comments for improvement are more than welcome. The needed table can be found in <a href="https://raw.githubusercontent.com/liniguez/InsplicoAnalysis/main/table_betAS.txt">here</a>.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-8_38a897446facaedaecd7b9957398469a">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>betasmat<span class="ot">&lt;-</span><span class="fu">read.table</span>(<span class="st">"table_betAS.txt"</span>) <span class="co">#This table is provided by the betAS package.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>givenCovfindIncr <span class="ot">&lt;-</span> <span class="cf">function</span>(cov, maxDevRef){</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(cov <span class="sc">&gt;</span> <span class="fu">max</span>(maxDevRef[,<span class="dv">1</span>])){</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    incr <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="fu">which</span>(cov <span class="sc">==</span> maxDevRef<span class="sc">$</span>cov)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    incr <span class="ot">&lt;-</span> maxDevRef<span class="sc">$</span>maxIncr[p]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(incr)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#I applied a recursive function with a limit of 10^7 sim for a pseudo p-value aproximation.</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>getpseudop<span class="ot">&lt;-</span><span class="cf">function</span>(inc1,excl1,inc2,excl2, <span class="at">seed=</span><span class="dv">12032024</span>){</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  nsim<span class="ot">=</span><span class="dv">1000</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  p_zero<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span>(p_zero<span class="sc">==</span><span class="dv">1</span> <span class="sc">&amp;</span> nsim<span class="sc">&lt;</span><span class="dv">10</span><span class="sc">^</span><span class="dv">7</span>){ </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    r1<span class="ot">&lt;-</span><span class="fu">rbeta</span>(nsim,inc1,excl1)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    r2<span class="ot">&lt;-</span><span class="fu">rbeta</span>(nsim,inc2,excl2)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    p_zero<span class="ot">&lt;-</span><span class="fu">sum</span>((r1<span class="sc">-</span>r2<span class="sc">&gt;</span><span class="dv">0</span>))<span class="sc">/</span>nsim</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    nsim<span class="ot">&lt;-</span>nsim<span class="sc">*</span><span class="dv">10</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  psudopval<span class="ot">&lt;-</span><span class="dv">1</span><span class="sc">-</span><span class="fu">abs</span>((p_zero<span class="fl">-0.5</span>)<span class="sc">*</span><span class="dv">2</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We need again the number of reads per sample that support inclusion/exclusion of the exon. We’ll need to modify a bit betAS pipeline. Pseudo-pvalue will be adjusted with fdr.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-9_42d0038999dedc3a2bb00a7eacc4ae70">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>resSimBeta_temp<span class="ot">&lt;-</span>rawinsp <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(psiFilt, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"ROW"</span>,<span class="st">"cluster"</span>)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cluster<span class="sc">==</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INC=</span>(EXON_INCLSPLICED_2DOSTRM<span class="sc">+</span>EXON_INCLSPLICED_2UPSTRM)<span class="sc">/</span><span class="dv">2</span>, <span class="co">#Here is set for long reads, but for short reads should be EXON_INCLSPLICED_2DOSTRM + EXON_INCLSPLICED_2UPSTRM and</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">EXCL=</span>EXON_EXCL) <span class="sc">%&gt;%</span> <span class="co"># EXON_EXCL*2</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INC=</span><span class="fu">ifelse</span>(INC<span class="sc">==</span><span class="dv">0</span>,<span class="fu">givenCovfindIncr</span>(<span class="fu">round</span>(EXCL),betasmat),INC))<span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EXCL=</span><span class="fu">ifelse</span>(EXCL<span class="sc">==</span><span class="dv">0</span>,<span class="fu">givenCovfindIncr</span>(<span class="fu">round</span>(INC),betasmat),EXCL)) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ROW,sample,cluster,INC,EXCL) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">"ROW"</span>,<span class="st">"cluster"</span>),<span class="at">names_from =</span> <span class="st">"sample"</span>,<span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"INC"</span>,<span class="st">"EXCL"</span>))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>resBETAS<span class="ot">&lt;-</span><span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(resSimBeta_temp<span class="sc">$</span>ROW),<span class="cf">function</span>(x){</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  res<span class="ot">&lt;-</span><span class="fu">getpseudop</span>(<span class="at">inc1=</span><span class="fu">as.numeric</span>(resSimBeta_temp[x,<span class="st">"INC_NB292"</span>]),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">excl1=</span><span class="fu">as.numeric</span>(resSimBeta_temp[x,<span class="st">"EXCL_NB292"</span>]),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">inc2=</span><span class="fu">as.numeric</span>(resSimBeta_temp[x,<span class="st">"INC_NB293"</span>]),</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">excl2=</span><span class="fu">as.numeric</span>(resSimBeta_temp[x,<span class="st">"EXCL_NB293"</span>]))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>resSimBeta_temp<span class="sc">$</span>psudopval<span class="ot">&lt;-</span>resBETAS</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>resSimBeta<span class="ot">&lt;-</span>resSimBeta_temp <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">sudopadj=</span> <span class="fu">p.adjust</span>(psudopval,<span class="at">method =</span> <span class="st">"fdr"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This is the filtered result:</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-10_0f6ebee60834c082db7c656186effef1">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>exons_results<span class="ot">&lt;-</span>psiFilt <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">dPSI=</span>NB293<span class="sc">-</span>NB292) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(resSimBeta, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"ROW"</span>,<span class="st">"cluster"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DiffSP=</span><span class="fu">ifelse</span>(sudopadj<span class="sc">&lt;</span><span class="fl">0.1</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(dPSI)<span class="sc">&gt;</span><span class="fl">0.15</span>,<span class="st">"DS"</span>,<span class="st">"ns"</span>),<span class="at">DiffSP=</span><span class="fu">factor</span>(DiffSP,<span class="at">levels=</span><span class="fu">c</span>(<span class="st">"ns"</span>,<span class="st">"DS"</span>)) ) </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>exons_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DiffSP<span class="sc">==</span><span class="st">"DS"</span>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(exons, <span class="at">by=</span><span class="st">"ROW"</span>) <span class="sc">%&gt;%</span> <span class="fu">data.table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   cluster ROW     NB292      NB293 prop_const prop_cryp      dPSI INC_NB292
1:       1 164 0.2724699 0.07202296          0       0.5 -0.200447       385
   INC_NB293 EXCL_NB292 EXCL_NB293 psudopval sudopadj DiffSP UPINT_MINLEN
1:       251       1028       3234         0        0     DS          104
   DOWNINT_MINLEN INTLEN_CONSIDERED EX_MINLEN EX_MAXLEN                  C1
1:           2934               104       171       397 135492291+135492378
                STARTS      ENDS                            C2  CHR STRAND
1: 135495313+135495539 135495709 135495814+135497188+135497583 chr6      -
   EXONTYPE             GID GNAME       GBIOTYPE EXMINL EXMAXL MINDISTC1START
1:      vts ENSG00000135541  ahi1 protein_coding    171    397           2934
   MINDISTENDC2 EXON_ID TOTALN_EXONS
1:          104      21           45</code></pre>
</div>
</div>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-11_2a1b34df6701c5b9ad9aa9bd19d24f4f">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data4plot<span class="ot">&lt;-</span>exons_results <span class="sc">%&gt;%</span> <span class="fu">filter</span>(DiffSP<span class="sc">==</span><span class="st">"DS"</span>) <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(exons, <span class="at">by=</span><span class="st">"ROW"</span>) <span class="sc">%&gt;%</span> <span class="fu">apply</span>(<span class="dv">1</span>,<span class="cf">function</span>(x){</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  nsim<span class="ot">&lt;-</span><span class="dv">1000</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  inc1<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(x[<span class="dv">8</span>])</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  excl1<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(x[<span class="dv">10</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  inc2<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(x[<span class="dv">9</span>])</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  excl2<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(x[<span class="dv">11</span>])</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  r1<span class="ot">&lt;-</span><span class="fu">rbeta</span>(nsim,inc1,excl1)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  r2<span class="ot">&lt;-</span><span class="fu">rbeta</span>(nsim,inc2,excl2)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="st">"a"</span><span class="ot">=</span>r1, <span class="st">"b"</span><span class="ot">=</span>r2) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">EXON_ID=</span>x[<span class="dv">34</span>], <span class="at">GENE=</span>x[<span class="dv">28</span>], <span class="at">C1=</span>x[<span class="dv">20</span>],<span class="at">STARTS=</span>x[<span class="dv">21</span>],<span class="at">ENDS=</span>x[<span class="dv">22</span>],<span class="at">C2=</span>x[<span class="dv">23</span>] )</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind,.)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>data4plot <span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">GENE=</span><span class="fu">toupper</span>(GENE))<span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fu">interaction</span>(GENE,EXON_ID)))<span class="sc">+</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">geom_violinhalf</span>(<span class="fu">aes</span>(<span class="at">y=</span>b, <span class="at">fill=</span><span class="st">"b"</span>), <span class="at">color=</span><span class="st">"gray30"</span>,<span class="at">trim =</span> F)<span class="sc">+</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  see<span class="sc">::</span><span class="fu">geom_violinhalf</span>(<span class="fu">aes</span>(<span class="at">y=</span>a, <span class="at">fill=</span><span class="st">"a"</span>),<span class="at">flip=</span><span class="cn">TRUE</span>, <span class="at">color=</span><span class="st">"gray30"</span>,<span class="at">trim=</span>F)<span class="sc">+</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"b"</span><span class="ot">=</span><span class="st">"orange"</span>,<span class="st">"a"</span><span class="ot">=</span><span class="st">"royalblue"</span>), <span class="at">name=</span><span class="st">"Samples"</span>)<span class="sc">+</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"PSI"</span>, <span class="at">x=</span><span class="st">"Gene.ExonID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="ScratchInsplicoAnalysis_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="with-replicates" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="with-replicates"><span class="header-section-number">5</span> With Replicates</h2>
<p>Now lets assume we have replicates and the different clusters are replicates of the sample. Here again we need to filter constitutive and cryptic exons. First, we’ll check what is the proportion of clusters from each sample where the number of reads supporting the inclusion/exclusion is greater than 15, and filter if the proportion is greater than 30%. This is too lax, but it is because of the toy data used, usually this proportion should be above 50%.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-12_860beae25d620927c135b6222ce0bfa7">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>insp_mod<span class="ot">&lt;-</span>rawinsp <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PSI_fil=</span><span class="fu">ifelse</span>(r_sup<span class="sc">&lt;</span><span class="dv">15</span>,<span class="cn">NA</span>,PSI_EX)) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PSI_fil))</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>nsamples_pergroup<span class="ot">&lt;-</span>rawinsp  <span class="sc">%&gt;%</span> <span class="fu">select</span>(sample,sample.cluster) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(sample) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">N_tot=</span><span class="fu">n</span>())</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>numEvpergr<span class="ot">&lt;-</span>insp_mod <span class="sc">%&gt;%</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROW,sample) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">N=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(nsamples_pergroup, <span class="at">by=</span><span class="st">"sample"</span>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">Prop=</span>N<span class="sc">/</span>N_tot) </span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>evin2check<span class="ot">&lt;-</span> numEvpergr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Prop<span class="sc">&gt;</span><span class="fl">0.30</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ROW) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">okgrps=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(okgrps<span class="sc">&gt;</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We then check what is the proportion of clusters in each sample where an exon is consitituve or cryptic. We filtered out exons where in more than 75% it showed a pattern of constitiuve or cryptic in both samples.</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-13_6526dd34e16e49b9eeb2eedf4a076b10">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>EvNOTCons<span class="ot">&lt;-</span>insp_mod <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PSI_EX <span class="sc">&gt;</span><span class="fl">0.9</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROW,sample) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">N_c=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(numEvpergr, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"ROW"</span>,<span class="st">"sample"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">N_c=</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(N_c),<span class="dv">0</span>,N_c),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">Prop_cons=</span>N_c<span class="sc">/</span>N) <span class="sc">%&gt;%</span> </span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prop_cons <span class="sc">&lt;</span><span class="fl">0.75</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ROW) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">okgrps=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(okgrps<span class="sc">&gt;=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ROW <span class="sc">%in%</span>evin2check<span class="sc">$</span>ROW )</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>EvNOTConsNOTCry<span class="ot">&lt;-</span>insp_mod <span class="sc">%&gt;%</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PSI_EX <span class="sc">&lt;</span><span class="fl">0.1</span> ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ROW,sample) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">N_c=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(numEvpergr, <span class="at">by=</span><span class="fu">c</span>(<span class="st">"ROW"</span>,<span class="st">"sample"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">N_c=</span><span class="fu">ifelse</span>(<span class="fu">is.na</span>(N_c),<span class="dv">0</span>,N_c),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">Prop_cons=</span>N_c<span class="sc">/</span>N) <span class="sc">%&gt;%</span> </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Prop_cons <span class="sc">&lt;</span><span class="fl">0.75</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(ROW) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">okgrps=</span><span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(okgrps<span class="sc">&gt;=</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ROW <span class="sc">%in%</span>evin2check<span class="sc">$</span>ROW )</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>evin2check<span class="ot">&lt;-</span>evin2check <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ROW <span class="sc">%in%</span> EvNOTCons<span class="sc">$</span>ROW <span class="sc">&amp;</span> ROW <span class="sc">%in%</span> EvNOTConsNOTCry<span class="sc">$</span>ROW )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For assesing DAS with replicates I used beta regression on the samples and p-values were adjusted with fdr</p>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-14_1e42e626174925e6abd16b8cc1045049">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ref<span class="ot">=</span><span class="st">"NB292"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>test<span class="ot">=</span><span class="st">"NB293"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>Rep_res<span class="ot">&lt;-</span>insp_mod <span class="sc">%&gt;%</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ROW <span class="sc">%in%</span> evin2check<span class="sc">$</span>ROW ) <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">split</span>(.<span class="sc">$</span>ROW) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(<span class="cf">function</span>(x){</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    ROW<span class="ot">=</span>x<span class="sc">$</span>ROW <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    temp<span class="ot">&lt;-</span>x<span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">GROUP=</span><span class="fu">factor</span>(sample,<span class="at">levels=</span><span class="fu">c</span>(ref,test))) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(GROUP))</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    pvalor<span class="ot">&lt;-</span>temp <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">PSI_EX=</span><span class="fu">ifelse</span>(PSI_EX<span class="sc">==</span><span class="dv">0</span>,<span class="fl">0.0001</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>                                       <span class="fu">ifelse</span>(PSI_EX<span class="sc">==</span><span class="dv">1</span>,<span class="fl">0.9999</span>,PSI_EX))) <span class="sc">%&gt;%</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">betareg</span>(PSI_EX <span class="sc">~</span>GROUP<span class="sc">|</span><span class="dv">1</span>,<span class="at">data =</span> .) <span class="sc">%&gt;%</span> <span class="fu">summary</span>() <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>      .<span class="sc">$</span>coefficients <span class="sc">%&gt;%</span> .<span class="sc">$</span>mean</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    pvalor<span class="ot">&lt;-</span>pvalor[<span class="fu">paste0</span>(<span class="st">"GROUP"</span>,test),<span class="st">'Pr(&gt;|z|)'</span>]</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    means<span class="ot">&lt;-</span>temp <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(GROUP) <span class="sc">%&gt;%</span> <span class="fu">reframe</span>(<span class="at">M=</span><span class="fu">mean</span>(PSI_EX))</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    ref_means<span class="ot">&lt;-</span>means <span class="sc">%&gt;%</span> <span class="fu">filter</span>(GROUP<span class="sc">==</span>ref)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    test_means<span class="ot">&lt;-</span>means  <span class="sc">%&gt;%</span> <span class="fu">filter</span>(GROUP<span class="sc">!=</span>ref)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    dPSI<span class="ot">&lt;-</span>test_means <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">dpsi=</span>M<span class="sc">-</span>ref_means<span class="sc">$</span>M, <span class="at">name=</span><span class="fu">paste0</span>(<span class="st">"GROUP"</span>,GROUP)) <span class="sc">%&gt;%</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(name,dpsi)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    result_out<span class="ot">&lt;-</span><span class="fu">tibble</span>(<span class="st">"ROW"</span><span class="ot">=</span>ROW,<span class="at">test_PSI=</span>test_means<span class="sc">$</span>M,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">ref_PSI=</span>ref_means<span class="sc">$</span>M, <span class="st">"dPSI"</span><span class="ot">=</span>dPSI<span class="sc">$</span>dpsi,<span class="st">"pvalue"</span><span class="ot">=</span>pvalor)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(result_out)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> <span class="fu">do.call</span>(rbind,.)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>Rep_res<span class="sc">$</span>padj<span class="ot">&lt;-</span><span class="fu">p.adjust</span>(Rep_res<span class="sc">$</span>pvalue, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="fu">subset</span>(Rep_res,padj<span class="sc">&lt;</span><span class="fl">0.1</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(dPSI)<span class="sc">&gt;</span><span class="fl">0.15</span>) <span class="sc">%&gt;%</span> <span class="fu">data.table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   ROW   test_PSI   ref_PSI       dPSI       pvalue         padj
1: 164 0.05105794 0.2479636 -0.1969056 6.209091e-16 4.346364e-15</code></pre>
</div>
</div>
<div class="cell" data-hash="ScratchInsplicoAnalysis_cache/html/unnamed-chunk-15_b7bec4accd1eb39dc2d939ac9ef1787e">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>data2plot<span class="ot">&lt;-</span> insp_mod <span class="sc">%&gt;%</span> <span class="fu">filter</span>(ROW <span class="sc">%in%</span> <span class="fu">subset</span>(Rep_res,padj<span class="sc">&lt;</span><span class="fl">0.1</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(dPSI)<span class="sc">&gt;</span><span class="fl">0.15</span>)<span class="sc">$</span>ROW)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>data2plot <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(exons, <span class="at">by=</span><span class="st">"ROW"</span>) <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">NAME=</span><span class="fu">paste0</span>(<span class="fu">toupper</span>(GNAME),<span class="st">"."</span>,EXON_ID)) <span class="sc">%&gt;%</span>  </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>sample, <span class="at">y=</span>PSI_EX))<span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape =</span> <span class="cn">NA</span>)<span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color=</span><span class="fu">as.factor</span>(cluster)), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width=</span><span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))<span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>NAME)<span class="sc">+</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y=</span><span class="st">"PSI"</span>)<span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>()<span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(), <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="ScratchInsplicoAnalysis_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>